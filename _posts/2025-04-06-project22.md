---
title: "[develop] 코드 리팩토링"
excerpt: "코드 리팩토링"

writer: Audrey
categories: [develop]

toc: true
toc_sticky: true

pin: true

date: 2025-04-04 22:27:00 +09:00
last_modified_at: 2025-04-04 22:27:00 +09:00

tags: [develop]
---


이미지 업로드 관련 코드들을 모두 수정하는 과정에서 기존 코드에서도 고쳐야 할 부분이 많이 보였다.  
그래서 고치는 김에 기존 코드 리팩토링도 진행하였다... 

### **현재 리팩토링이 필요한 부분**

**이미지 업로드와 DB 이미지 경로 저장 순서 변경**
- 이미지 업로드 먼저 한뒤 반환한 이미지 경로를 DB에 저장하는 순서였으나, DB 관련 처리 중 에러가 발생해서 롤백되었을 때 이미지가 이미 업로드 되었거나 삭제된 경우 돌이킬 수 없으므로 둘의 순서를 변경해야 한다.
    - DB 저장 성공 후 이미지를 업로드 혹은 삭제하는 방식으로 변경
- 이미지 처리 과정에서 문제 생길 경우 에러 처리하는 방식 통일 시키기
    - 에러를 위로 던져서 최상위 메소드(updateReview, insertReview)에서 처리하도록 함.

<br>

**현재 리뷰 작성, 리뷰 수정, 삭제등을 보면 한 서비스 내에서 너무 많은 기능을 한번에 처리하고 있음.**  
- 단일 책임 원칙에 잘 맞지 않는 코드 구조이고, 모르는 사람이 코드를 보았을 때 이 부분이 어떤걸 처리하는 부분인지 눈에 한번에 잘 들어오지 않는다.  
    - 메소드 하나당 하나의 기능을 담당하도록 분리한다.  
- 예를 들어 리뷰 작성의 경우 아래 4가지를 처리해야 한다.  
    - 제품 처리(신규 제품일 경우 제품 추가, 기존 제품일 경우 해당 제품 조회)  
    - 리뷰 데이터 저장  
    - 해당 제품의 별점 총합 및 리뷰 개수 업데이트  
    - 리뷰 이미지 업로드  
- 그러므로 위의 기능들을 따로 분리한다.  
    - 이때 이미지 업로드 같이 다른 기능에서도 사용되는 것들은 일반화 시켜서 다른데서도 사용할 수 있도록 작성한다.

<br>

**중복되는 부분 메소드로 빼기**
- 리뷰 수정, 삭제에서 리뷰 작성자의 memberId값과 현재 로그인된 유저의 memberId값을 비교해서 다를 경우 권한 없음 처리하는 부분 중복
    - checkAuthority()  
- 리뷰 작성, 수정, 삭제에서 리뷰에 해당하는 제품의 별점 총합 및 리뷰 개수 업데이트 부분 로직이 중복
    - updateProductStats

<br>

**엔티티, DTO 등 객체명이 불필요하게 길다.**
- 원래는 엔티티면 끝에 Entity를 붙였는데 변수명이 길어지다보니 코드도 길어짐.
- 그리하여 Review를 예를 들면 엔티티는 review, DTO는 reviewDTO로 변경

<br>

**트랜잭션 적용 수정**
- 최상위 메소드(리뷰 작성, 수정, 삭제, 목록 조회등..)
    - @Transactional
- 내부에서 호출되는 하위 메소드(리뷰 이미지 업로드, 리뷰 이미지 대표 여부 설정, 권한 여부 검사 등)
    - 붙이지 않는다.
    - 원래는 @Transactional(propagation = Propagation.REQUIRED)를 붙여서 기존 트랜잭션이 있는 경우 합류하고 없을 경우 새 트랜잭션 적용을 하려고 했으나
        - 같은 클래스 내에서 this.메소드()로 호출하는 경우 해당 메소드의 @Transacitonal은 무시된다고 한다. 왜냐하면 프록시를 거치지 않고 직접 호출이기 때문…
        - 그러므로 붙이지 않고 부모 트랜잭션을 따라가도록 한다.
- 외부에서 호출되는 하위 메소드(제품 별점 및 리뷰 개수 업데이트, 제품 추가 등..)
    - @Transactional(propagation = Propagation.REQUIRED)를 붙인다.
    - 단독으로 호출될 가능성이 있으므로..


