---
title: "[develop] 배포2"
excerpt: "배포2"

writer: Audrey
categories: [develop]

toc: true
toc_sticky: true

published: false

date: 2025-03-19 22:35:00 +09:00
last_modified_at: 2025-03-19 22:35:00 +09:00

tags: [develop]
---

### 1. DockerFile 작성

```docker
FROM openjdk:17-jdk-slim

WORKDIR /app

# JAR 파일을 컨테이너 내부로 복사 (실제 JAR 경로 확인)
COPY build/libs/*.jar app.jar

# 환경변수 설정
ENV SPRING_PROFILES_ACTIVE=prod

# 애플리케이션 실행
ENTRYPOINT ["java", "-jar", "app.jar"]
```

- SPRING_PROFILES_ACTIVE=prod를 설정하면 application-prod.yml 파일을 자동으로 사용한다.
- 현재 gradle을 사용하고 있기 때문에 JAR 파일 경로는 build/libs/*.jar으로 설정한다.

### 2. Docker Compose 설정하기

- 현재 MariaDB와 Spring boot를 함께 실행하기 위해 여러 개의 컨테이너를 관리할 수 있는 도커 컴포즈를 사용한다.

```docker
version: '3.8'

services:
  mariadb: # mariaDB 컨테이너(DB 서버) 실행
    image: mariadb:latest
    container_name: snackpick-db
    restart: always
    environment: # mariadb의 환경변수
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    ports:
      - "3307:3306"
    volumes:
      - mariadb_data:/var/lib/mysql

  snackpick-app: # Spring Boot 컨테이너(백엔드 서버) 실행
    build:
      context: . # 현재 디렉토리(.)에서 Dockerfile을 찾아서 실행
      dockerfile: Dockerfile
    container_name: snackpick-backend
    restart: always
    depends_on:
      - mariadb
    environment: # Spring Boot컨테이너의 환경 변수 설정
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL}
      SPRING_DATASOURCE_USERNAME: ${MARIADB_USER}
      SPRING_DATASOURCE_PASSWORD: ${MARIADB_PASSWORD}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
    ports:
      - "8080:8080"

volumes:
  mariadb_data:

```

- Services
    - 생성될 컨테이너를 묶어놓은 단위이다.
- image: 서비스의 컨테이너 생성할 때 쓰일 이미지 이름
- environment
    - docker - -env 혹은 -e 옵션과 동일함.
    - 서비스의 컨테이너 내부에서 사용할 환경변수 지정
- command
    - 컨테이너가 실행될 때 수행할 명령어 설정
- depends_on
    - 해당 항목에 명시된 컨테이너가 먼저 생성되고 실행된다.
- build
    - 해당 항목에 정의된 Dockerfile에서 이미지를 빌드해서 서비스의 컨테이너를 생성하도록 설정한다.

### 3. jar 파일 준비

```docker
./gradlew bootJar
```

- 위 명령어를 실행해 jar 파일을 준비한다.

```docker
docker-compose build
docker-compose up -d
```

- 이미지를 만든 뒤 컨테이너를 실행했으나 에러가 뜬다.